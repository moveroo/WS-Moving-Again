---
interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  canonical?: string;
  noindex?: boolean;
  lang?: string;
  modifiedDate?: string; // ISO date string (Git commit date, file mod date, or build time)
  author?: string; // Author name (defaults to organization name for business pages)
  publishedDate?: string; // ISO date string for article:published_time
}

// Production domain - always use this for canonical URLs
const PRODUCTION_DOMAIN = 'https://movingagain.com.au';

// Build canonical URL using production domain + current path
const currentPath = Astro.url.pathname;
const defaultCanonical = `${PRODUCTION_DOMAIN}${currentPath}`;

const {
  title,
  description: rawDescription = import.meta.env.PUBLIC_SITE_DESCRIPTION || '',
  image = import.meta.env.PUBLIC_SITE_IMAGE || '/logo.png',
  type = 'website',
  canonical = defaultCanonical,
  noindex = false,
  modifiedDate,
  author,
  publishedDate,
} = Astro.props;

// SEO best practice: Descriptions should be 150-160 characters
const DESC_MIN_LENGTH = 120;
const DESC_MAX_LENGTH = 160;

// Validate and optimize description length
let description = rawDescription.trim();
if (description.length > DESC_MAX_LENGTH) {
  // Truncate at word boundary
  const truncated = description.substring(0, DESC_MAX_LENGTH - 3);
  const lastSpace = truncated.lastIndexOf(' ');
  description =
    lastSpace > DESC_MAX_LENGTH - 20
      ? truncated.substring(0, lastSpace) + '...'
      : truncated + '...';
} else if (description.length < DESC_MIN_LENGTH && description.length > 0) {
  // Add default description if too short
  const defaultDesc =
    "Australia's trusted interstate removalists. Save up to 60% with backloading services. Get your free quote today.";
  description = description || defaultDesc;
} else if (description.length === 0) {
  // Use default if empty
  description =
    "Australia's trusted interstate removalists. Save up to 60% with backloading services. Get your free quote today.";
}

const siteName = import.meta.env.PUBLIC_SITE_NAME || 'Moving Again';
// Default author for business pages (organization name)
// For business/service sites, the organization is the author
const defaultAuthor = 'Moving Again'; // Use brand name directly
const pageAuthor = author || defaultAuthor;
// SEO best practice: Titles should be 50-60 characters
const MAX_TITLE_LENGTH = 60;
const suffix = ` | ${siteName}`;
const movingAgainSuffix = ' | Moving Again';
const MAX_TITLE_WITHOUT_SUFFIX = MAX_TITLE_LENGTH - suffix.length; // ~42 chars

let pageTitle: string;
if (title) {
  // Check if title already has suffix
  const hasSuffix = title.endsWith(suffix) || title.endsWith(movingAgainSuffix);

  // Special case: If title starts with "Moving Again", ensure it stays
  const startsWithMovingAgain = title.trim().startsWith('Moving Again');

  if (hasSuffix) {
    // Title already has suffix - truncate if too long
    if (title.length > MAX_TITLE_LENGTH) {
      // Remove suffix, truncate, then re-add
      const withoutSuffix = title.replace(/\s*\|\s*Moving Again\s*$/, '').trim();
      const truncated = withoutSuffix.substring(0, MAX_TITLE_WITHOUT_SUFFIX - 3);
      const lastSpace = truncated.lastIndexOf(' ');
      const cleanTitle =
        lastSpace > MAX_TITLE_WITHOUT_SUFFIX - 20 ? truncated.substring(0, lastSpace) : truncated;
      pageTitle = cleanTitle.trim() + suffix;
    } else {
      pageTitle = title;
    }
  } else {
    // Title doesn't have suffix - truncate before adding
    let cleanTitle = title.trim();

    // If title starts with "Moving Again", ensure it's preserved
    if (startsWithMovingAgain) {
      // For titles starting with "Moving Again", we want: "Moving Again | [rest] | Moving Again"
      // But that's redundant, so just ensure "Moving Again" is at the start
      // If it's too long, truncate the middle part
      if (cleanTitle.length > MAX_TITLE_LENGTH) {
        // Keep "Moving Again" at start, truncate the rest
        const rest = cleanTitle.substring(13).trim(); // After "Moving Again"
        const maxRestLength = MAX_TITLE_LENGTH - 13 - suffix.length; // Space for "Moving Again " + suffix
        if (rest.length > maxRestLength) {
          const truncated = rest.substring(0, maxRestLength - 3);
          const lastSpace = truncated.lastIndexOf(' ');
          const truncatedRest =
            lastSpace > maxRestLength - 20 ? truncated.substring(0, lastSpace) : truncated;
          cleanTitle = `Moving Again ${truncatedRest.trim()}...`;
        } else {
          cleanTitle = `Moving Again ${rest}`;
        }
      }
      // Don't add suffix if title already starts with "Moving Again" (avoid duplication)
      pageTitle = cleanTitle;
    } else {
      // Normal title - truncate before adding suffix
      if (cleanTitle.length > MAX_TITLE_WITHOUT_SUFFIX) {
        const truncated = cleanTitle.substring(0, MAX_TITLE_WITHOUT_SUFFIX - 3);
        const lastSpace = truncated.lastIndexOf(' ');
        cleanTitle =
          lastSpace > MAX_TITLE_WITHOUT_SUFFIX - 20 ? truncated.substring(0, lastSpace) : truncated;
        cleanTitle = cleanTitle.trim() + '...';
      }
      pageTitle = cleanTitle + suffix;
    }
  }

  // Final safety check - but preserve "Moving Again" if it's at the start
  if (pageTitle.length > MAX_TITLE_LENGTH) {
    if (pageTitle.startsWith('Moving Again')) {
      // Keep "Moving Again" and truncate the rest
      const rest = pageTitle.substring(13).trim();
      const maxRestLength = MAX_TITLE_LENGTH - 13;
      if (rest.length > maxRestLength) {
        const truncated = rest.substring(0, maxRestLength - 3);
        const lastSpace = truncated.lastIndexOf(' ');
        pageTitle =
          lastSpace > maxRestLength - 20
            ? `Moving Again ${truncated.substring(0, lastSpace)}...`
            : `Moving Again ${truncated}...`;
      }
    } else {
      const truncated = pageTitle.substring(0, MAX_TITLE_LENGTH - 3);
      const lastSpace = truncated.lastIndexOf(' ');
      pageTitle =
        lastSpace > MAX_TITLE_LENGTH - 20
          ? truncated.substring(0, lastSpace) + '...'
          : truncated + '...';
    }
  }
} else {
  pageTitle = siteName;
}
---

<!doctype html>
<html lang={Astro.props.lang || 'en'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="mask-icon" href="/favicon.svg" color="#D90000" />
    <meta name="theme-color" content="#D90000" />

    <!-- Mobile Web App Meta Tags (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content={siteName} />
    <meta name="mobile-web-app-capable" content="yes" />

    <link rel="manifest" href="/manifest.json" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="generator" content={Astro.generator} />
    <link rel="canonical" href={canonical} />

    <!-- Content Freshness - Use provided date, Git commit date, file mod date, or build time -->
    <meta property="article:modified_time" content={modifiedDate || new Date().toISOString()} />
    {publishedDate && <meta property="article:published_time" content={publishedDate} />}

    <!-- Author Attribution (E-E-A-T) -->
    <meta name="author" content={pageAuthor} />
    <meta property="article:author" content={pageAuthor} />

    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />

    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    {image && <meta property="og:image" content={new URL(image, Astro.url)} />}
    <meta property="og:site_name" content={siteName} />
    {publishedDate && <meta property="article:published_time" content={publishedDate} />}
    {modifiedDate && <meta property="article:modified_time" content={modifiedDate} />}
    <meta property="article:author" content={pageAuthor} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={pageTitle} />
    <meta property="twitter:description" content={description} />
    {image && <meta property="twitter:image" content={new URL(image, Astro.url)} />}
    <!-- Twitter Site Attribution - Add when Twitter account is available -->
    <!-- <meta name="twitter:site" content="@movingagain" /> -->

    <slot name="head" />
  </head>
  <body>
    <slot />
  </body>
</html>
