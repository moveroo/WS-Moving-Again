---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import RouteQuoteCTA from '../components/RouteQuoteCTA.astro';
import RouteFAQ from '../components/RouteFAQ.astro';
import RelatedRoutes from '../components/RelatedRoutes.astro';
import RouteServiceOptions from '../components/RouteServiceOptions.astro';
import RouteProcess from '../components/RouteProcess.astro';
import RouteTrustSection from '../components/RouteTrustSection.astro';
import { generateFAQsForRoute } from '../utils/faqGenerator';
import { getRelatedRoutes } from '../utils/relatedRoutes';
import { getCityHubUrl } from '../utils/hubPages';
import { generateRouteSEO } from '../utils/seoGenerator';
import { getContentCollectionDate } from '../utils/fileDates';

export async function getStaticPaths() {
  const routes = await getCollection('routes');

  return routes.map((route) => ({
    params: { slug: route.data.slugFs },
    props: { route },
  }));
}

const allRoutes = await getCollection('routes');
const { route } = Astro.props as { route: CollectionEntry<'routes'> };

// Generate route-specific FAQs
const faqs = generateFAQsForRoute(route);

// Get related routes (increased to 10 for full coverage)
const originRelated = getRelatedRoutes(allRoutes, route, 'origin', 10);
const destinationRelated = getRelatedRoutes(allRoutes, route, 'destination', 10);

// Get hub page URLs for internal linking
const originHubUrl = getCityHubUrl(route.data.origin);
const destinationHubUrl = getCityHubUrl(route.data.destination);

// Generate breadcrumb items for schema
const siteUrl = import.meta.env.SITE || 'https://movingagain.com.au';
const breadcrumbItems = [
  { name: 'Home', url: `${siteUrl}/` },
  { name: 'Backloading', url: `${siteUrl}/backloading/` },
  ...(originHubUrl ? [{ name: route.data.origin, url: `${siteUrl}${originHubUrl}` }] : []),
  {
    name: `${route.data.origin} to ${route.data.destination}`,
    url: `${siteUrl}/${route.data.slugFs}/`,
  },
];

// Get content modification date (Git commit date, file mod date, or build time)
const contentDate = getContentCollectionDate('routes', route.id);

// Generate SEO-optimized title and description
// Always use generated SEO for route pages to ensure optimal length and format
const seo = generateRouteSEO({
  origin: route.data.origin,
  destination: route.data.destination,
  originState: route.data.originState,
  destinationState: route.data.destinationState,
  transitDays: route.data.transitDays,
  title: route.data.title, // Use as base, but generator will optimize it
});

// Use generated SEO (optimized for length and format)
const pageTitle = seo.title;
const metaDescription = seo.description;

// Machine-readable facts for LLM extraction
const routeFacts = {
  service: 'Interstate backloading',
  route: `${route.data.origin} to ${route.data.destination}`,
  origin: route.data.origin,
  origin_state: route.data.originState,
  destination: route.data.destination,
  destination_state: route.data.destinationState,
  transit_time: route.data.transitDays || '3-7 business days',
  typical_savings: '40-60%',
  auto_quote_available: true,
  transit_insurance_included: true,
  door_to_door: true,
};

// Structured data for SEO
const schemaData = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: pageTitle.replace(` | Moving Again`, ''), // Remove suffix for schema
  description: metaDescription,
  provider: {
    '@type': 'MovingCompany',
    name: 'Moving Again',
  },
  areaServed: [
    { '@type': 'City', name: route.data.origin },
    { '@type': 'City', name: route.data.destination },
  ],
  serviceType: 'Interstate Backloading',
};

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqs.map((faq) => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: faq.answer,
    },
  })),
};
---

<Layout title={pageTitle} description={metaDescription} modifiedDate={contentDate}>
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  <!-- BreadcrumbList Schema -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BreadcrumbList',
      itemListElement: breadcrumbItems.map((item, index) => ({
        '@type': 'ListItem',
        position: index + 1,
        name: item.name,
        item: item.url,
      })),
    })}
  />
  <!-- Machine-readable facts for LLM extraction -->
  <script type="application/json" id="route-facts" set:html={JSON.stringify(routeFacts)} />

  <!-- Hero -->
  <section class="bg-gradient-to-br from-brand-dark to-gray-900 text-white py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl mx-auto text-center">
        <span
          class="inline-block px-4 py-1 mb-6 rounded-full bg-brand-yellow/20 text-brand-yellow font-bold uppercase tracking-wider text-sm"
        >
          Interstate Backloading
        </span>

        <h1 class="text-4xl md:text-5xl font-black mb-4">
          {route.data.title}
        </h1>

        <p class="text-xl text-gray-300 mb-2">
          {route.data.origin}, {route.data.originState} ‚Üí {route.data.destination}, {
            route.data.destinationState
          }
        </p>

        {
          route.data.transitDays && (
            <p class="text-gray-400 mb-8 max-w-2xl mx-auto">
              {route.data.transitDays.includes('10-') || route.data.transitDays.includes('14') ? (
                <span>
                  Start your <strong>long-distance move</strong> from {route.data.origin} on the
                  right foot. Standard transit time is {route.data.transitDays}.
                </span>
              ) : (
                <span>
                  Quick and efficient interstate transport. Typical transit time:{' '}
                  {route.data.transitDays}.
                </span>
              )}
            </p>
          )
        }

        {/* State-specific advisory */}
        {
          route.data.destinationState === 'QLD' && (
            <div class="mb-8 p-4 bg-white/10 rounded-lg text-sm text-gray-200 max-w-xl mx-auto border border-white/10">
              <strong>Moving to Queensland?</strong> Ask us about our heat-safe transport options
              for sensitive items.
            </div>
          )
        }
        {
          route.data.destinationState === 'WA' && (
            <div class="mb-8 p-4 bg-white/10 rounded-lg text-sm text-gray-200 max-w-xl mx-auto border border-white/10">
              <strong>Heading West?</strong> We handle all biosecurity declaration forms for your
              household plants.
            </div>
          )
        }
        {
          route.data.destinationState === 'TAS' && (
            <div class="mb-8 p-4 bg-white/10 rounded-lg text-sm text-gray-200 max-w-xl mx-auto border border-white/10">
              <strong>Bass Strait Crossing:</strong> Our quotes include ferry costs. No hidden fees.
            </div>
          )
        }

        <div class="flex flex-col gap-4 justify-center items-center">
          <a
            data-brain-track="quote"
            href="https://removalistquotes.movingagain.com.au/quote/household"
            class="inline-block py-4 px-8 bg-brand-red text-white font-bold rounded-brand text-lg hover:bg-brand-accent transition-colors shadow-lg"
          >
            Get a Free Quote
          </a>
          <p class="text-xs text-gray-500">
            Daily departures from {route.data.originState} to {route.data.destinationState}
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Breadcrumb -->
  <nav class="py-4 bg-[#800005]">
    <div class="container mx-auto px-4">
      <div class="flex items-center gap-2 text-sm text-white/80 flex-wrap">
        <a href="/" class="hover:text-white">Home</a>
        <span>‚Ä∫</span>
        <a href="/backloading/" class="hover:text-white">Backloading</a>
        <span>‚Ä∫</span>
        {
          originHubUrl ? (
            <a href={originHubUrl} class="hover:text-white">
              {route.data.origin}
            </a>
          ) : (
            <span>{route.data.origin}</span>
          )
        }
        <span>‚Üí</span>
        {
          destinationHubUrl ? (
            <a href={destinationHubUrl} class="hover:text-white">
              {route.data.destination}
            </a>
          ) : (
            <span class="text-white">{route.data.destination}</span>
          )
        }
      </div>
    </div>
  </nav>

  <!-- Service Options Section -->
  <RouteServiceOptions origin={route.data.origin} destination={route.data.destination} />

  <!-- Related Routes from Origin -->
  {
    originRelated.length > 0 && (
      <RelatedRoutes title={`More routes from ${route.data.origin}`} routes={originRelated} />
    )
  }

  <!-- Transport Process Section -->
  <RouteProcess
    origin={route.data.origin}
    destination={route.data.destination}
    transitDays={route.data.transitDays}
  />

  <!-- Trust Section -->
  <RouteTrustSection origin={route.data.origin} destination={route.data.destination} />

  <!-- FAQ Section -->
  <RouteFAQ faqs={faqs} />

  <!-- Related Routes to Destination -->
  {
    destinationRelated.length > 0 && (
      <RelatedRoutes
        title={`More routes to ${route.data.destination}`}
        routes={destinationRelated}
      />
    )
  }

  <!-- Explore Service Areas -->
  {
    (originHubUrl || destinationHubUrl) && (
      <section class="py-12 bg-white border-t">
        <div class="container mx-auto px-4">
          <h2 class="text-2xl font-bold text-center text-brand-dark mb-8">Explore More Routes</h2>
          <div class="flex flex-wrap justify-center gap-4 max-w-2xl mx-auto">
            {originHubUrl && (
              <a
                href={originHubUrl}
                class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-brand-red hover:text-white text-brand-dark font-semibold rounded-xl transition-colors"
              >
                <span>üó∫Ô∏è</span>
                <span>All {route.data.origin} Routes</span>
              </a>
            )}
            {destinationHubUrl && (
              <a
                href={destinationHubUrl}
                class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-brand-red hover:text-white text-brand-dark font-semibold rounded-xl transition-colors"
              >
                <span>üó∫Ô∏è</span>
                <span>All {route.data.destination} Routes</span>
              </a>
            )}
          </div>
        </div>
      </section>
    )
  }

  <!-- Quote CTA -->
  <RouteQuoteCTA origin={route.data.origin} destination={route.data.destination} />
</Layout>
